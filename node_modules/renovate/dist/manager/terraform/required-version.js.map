{"version":3,"file":"required-version.js","sourceRoot":"","sources":["../../../lib/manager/terraform/required-version.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,mFAAqE;AACrE,yCAAsC;AAEtC,qCAAoD;AAEpD,iCAAiD;AAEjD,SAAgB,+BAA+B,CAC7C,YAAoB,EACpB,KAAe;IAEf,MAAM,IAAI,GAAwB,EAAE,CAAC;IACrC,IAAI,UAAU,GAAG,YAAY,CAAC;IAC9B,IAAI,YAAY,GAAG,CAAC,CAAC;IACrB,GAAG;QACD,qBAAqB;QACrB,IAAI,UAAU,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;YACjC,eAAM,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAC;SACpD;QAED,MAAM,IAAI,GAAG,KAAK,CAAC,UAAU,CAAC,CAAC;QAC/B,oIAAoI;QACpI,MAAM,YAAY,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC;QACtD,MAAM,cAAc,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC;QACxD,YAAY,GAAG,YAAY,GAAG,YAAY,GAAG,cAAc,CAAC;QAE5D,MAAM,OAAO,GAAG,8BAAuB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACnD,IAAI,OAAO,IAAI,OAAO,CAAC,MAAM,CAAC,GAAG,KAAK,kBAAkB,EAAE;YACxD,MAAM,GAAG,GAAsB;gBAC7B,YAAY,EAAE,OAAO,CAAC,MAAM,CAAC,KAAK;gBAClC,UAAU;gBACV,WAAW,EAAE;oBACX,uBAAuB,EAAE,iCAAwB,CAAC,iBAAiB;iBACpE;aACF,CAAC;YACF,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACf,gFAAgF;YAChF,uGAAuG;YACvG,OAAO,EAAE,UAAU,EAAE,YAAY,EAAE,YAAY,EAAE,IAAI,EAAE,CAAC;SACzD;QAED,UAAU,IAAI,CAAC,CAAC;KACjB,QAAQ,YAAY,KAAK,CAAC,EAAE;IAC7B,OAAO,IAAI,CAAC;AACd,CAAC;AArCD,0EAqCC;AAED,SAAgB,uBAAuB,CAAC,GAAsB;IAC5D,sCAAsC;IACtC,GAAG,CAAC,OAAO,GAAG,kBAAkB,CAAC;IACjC,GAAG,CAAC,UAAU,GAAG,oBAAoB,CAAC,EAAE,CAAC;IACzC,GAAG,CAAC,OAAO,GAAG,qBAAqB,CAAC;IACpC,GAAG,CAAC,cAAc,GAAG,kBAAkB,CAAC;IACxC,qCAAqC;AACvC,CAAC;AAPD,0DAOC","sourcesContent":["import * as datasourceGithubTags from '../../datasource/github-tags';\nimport { logger } from '../../logger';\nimport type { PackageDependency } from '../types';\nimport { TerraformDependencyTypes } from './common';\nimport type { ExtractionResult } from './types';\nimport { keyValueExtractionRegex } from './util';\n\nexport function extractTerraformRequiredVersion(\n  startingLine: number,\n  lines: string[]\n): ExtractionResult {\n  const deps: PackageDependency[] = [];\n  let lineNumber = startingLine;\n  let braceCounter = 0;\n  do {\n    // istanbul ignore if\n    if (lineNumber > lines.length - 1) {\n      logger.debug(`Malformed Terraform file detected.`);\n    }\n\n    const line = lines[lineNumber];\n    // `{` will be counted wit +1 and `}` with -1. Therefore if we reach braceCounter == 0. We have found the end of the terraform block\n    const openBrackets = (line.match(/\\{/g) || []).length;\n    const closedBrackets = (line.match(/\\}/g) || []).length;\n    braceCounter = braceCounter + openBrackets - closedBrackets;\n\n    const kvMatch = keyValueExtractionRegex.exec(line);\n    if (kvMatch && kvMatch.groups.key === 'required_version') {\n      const dep: PackageDependency = {\n        currentValue: kvMatch.groups.value,\n        lineNumber,\n        managerData: {\n          terraformDependencyType: TerraformDependencyTypes.terraform_version,\n        },\n      };\n      deps.push(dep);\n      // returning starting line as required_providers are also in the terraform block\n      // if we would return the position of the required_version line we would potentially skip the providers\n      return { lineNumber: startingLine, dependencies: deps };\n    }\n\n    lineNumber += 1;\n  } while (braceCounter !== 0);\n  return null;\n}\n\nexport function analyseTerraformVersion(dep: PackageDependency): void {\n  /* eslint-disable no-param-reassign */\n  dep.depType = 'required_version';\n  dep.datasource = datasourceGithubTags.id;\n  dep.depName = 'hashicorp/terraform';\n  dep.extractVersion = 'v(?<version>.*)$';\n  /* eslint-enable no-param-reassign */\n}\n"]}