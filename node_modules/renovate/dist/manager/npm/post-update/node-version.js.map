{"version":3,"file":"node-version.js","sourceRoot":"","sources":["../../../../lib/manager/npm/post-update/node-version.ts"],"names":[],"mappings":";;;AAAA,mCAA+C;AAC/C,4CAAyC;AACzC,yCAAqE;AACrE,mDAAoD;AAGpD,KAAK,UAAU,WAAW,CAAC,QAAgB;IACzC,IAAI;QACF,MAAM,UAAU,GAAG,CAAC,MAAM,IAAA,kBAAa,EAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;aACvD,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;aACd,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;QACrB,IAAI,IAAA,mBAAU,EAAC,UAAU,CAAC,EAAE;YAC1B,eAAM,CAAC,KAAK,CAAC,0BAA0B,UAAU,UAAU,QAAQ,EAAE,CAAC,CAAC;YACvE,OAAO,UAAU,CAAC;SACnB;KACF;IAAC,OAAO,GAAG,EAAE;QACZ,aAAa;KACd;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAS,wBAAwB,CAAC,MAAwB;;IACxD,MAAM,UAAU,GAAW,MAAA,MAAM,CAAC,WAAW,0CAAE,IAAI,CAAC;IACpD,IAAI,UAAU,IAAI,IAAA,mBAAU,EAAC,UAAU,CAAC,EAAE;QACxC,eAAM,CAAC,KAAK,CAAC,0BAA0B,UAAU,qBAAqB,CAAC,CAAC;QACxE,OAAO,UAAU,CAAC;KACnB;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAEM,KAAK,UAAU,iBAAiB,CACrC,MAAwB,EACxB,aAAa,GAAG,KAAK;IAErB,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM,CAAC;IAC/B,IAAI,UAAU,GACZ,CAAC,MAAM,WAAW,CAAC,IAAA,uBAAkB,EAAC,WAAW,EAAE,QAAQ,CAAC,CAAC,CAAC;QAC9D,CAAC,MAAM,WAAW,CAAC,IAAA,uBAAkB,EAAC,WAAW,EAAE,eAAe,CAAC,CAAC,CAAC;QACrE,wBAAwB,CAAC,MAAM,CAAC,CAAC;IACnC,IAAI,eAAe,GAAG,CAAC,CAAC;IACxB,IAAI;QACF,MAAM,YAAY,GAAG,IAAA,uBAAkB,EAAC,WAAW,EAAE,mBAAmB,CAAC,CAAC;QAC1E,eAAe,GAAG,IAAI,CAAC,KAAK,CAC1B,MAAM,IAAA,kBAAa,EAAC,YAAY,EAAE,MAAM,CAAC,CAC1C,CAAC,eAAe,CAAC;KACnB;IAAC,OAAO,GAAG,EAAE;QACZ,aAAa;KACd;IACD,oEAAoE;IACpE,kCAAkC;IAClC,IAAI,UAAU,EAAE;QACd,IACE,IAAA,mBAAU,EAAC,UAAU,CAAC;YACtB,IAAA,kBAAS,EAAC,UAAU,EAAE,UAAU,CAAC;YACjC,IAAA,kBAAS,EAAC,UAAU,EAAE,UAAU,CAAC;YACjC,CAAC,IAAA,eAAQ,EAAC,UAAU,CAAC,EACrB;YACA,IAAI,eAAe,KAAK,CAAC,EAAE;gBACzB,eAAM,CAAC,KAAK,CAAC,qDAAqD,CAAC,CAAC;gBACpE,UAAU,GAAG,MAAM,CAAC;aACrB;iBAAM,IAAI,IAAA,mBAAU,EAAC,GAAG,UAAU,MAAM,CAAC,EAAE;gBAC1C,eAAM,CAAC,KAAK,CAAC,wCAAwC,CAAC,CAAC;gBACvD,UAAU,GAAG,GAAG,UAAU,MAAM,CAAC;aAClC;SACF;KACF;SAAM,IAAI,aAAa,IAAI,eAAe,KAAK,CAAC,EAAE;QACjD,eAAM,CAAC,KAAK,CAAC,uCAAuC,CAAC,CAAC;QACtD,UAAU,GAAG,MAAM,CAAC;KACrB;SAAM;QACL,eAAM,CAAC,KAAK,CAAC,yCAAyC,CAAC,CAAC;KACzD;IACD,OAAO,UAAU,CAAC;AACpB,CAAC;AA1CD,8CA0CC","sourcesContent":["import { satisfies, validRange } from 'semver';\nimport { logger } from '../../../logger';\nimport { getSiblingFileName, readLocalFile } from '../../../util/fs';\nimport { isStable } from '../../../versioning/node';\nimport type { PostUpdateConfig } from '../../types';\n\nasync function getNodeFile(filename: string): Promise<string> | null {\n  try {\n    const constraint = (await readLocalFile(filename, 'utf8'))\n      .split('\\n')[0]\n      .replace(/^v/, '');\n    if (validRange(constraint)) {\n      logger.debug(`Using node constraint \"${constraint}\" from ${filename}`);\n      return constraint;\n    }\n  } catch (err) {\n    // do nothing\n  }\n  return null;\n}\n\nfunction getPackageJsonConstraint(config: PostUpdateConfig): string | null {\n  const constraint: string = config.constraints?.node;\n  if (constraint && validRange(constraint)) {\n    logger.debug(`Using node constraint \"${constraint}\" from package.json`);\n    return constraint;\n  }\n  return null;\n}\n\nexport async function getNodeConstraint(\n  config: PostUpdateConfig,\n  allowUnstable = false\n): Promise<string> | null {\n  const { packageFile } = config;\n  let constraint =\n    (await getNodeFile(getSiblingFileName(packageFile, '.nvmrc'))) ||\n    (await getNodeFile(getSiblingFileName(packageFile, '.node-version'))) ||\n    getPackageJsonConstraint(config);\n  let lockfileVersion = 1;\n  try {\n    const lockFileName = getSiblingFileName(packageFile, 'package-lock.json');\n    lockfileVersion = JSON.parse(\n      await readLocalFile(lockFileName, 'utf8')\n    ).lockfileVersion;\n  } catch (err) {\n    // do nothing\n  }\n  // Avoid using node 15 if node 14 also satisfies the same constraint\n  // Remove this once node 16 is LTS\n  if (constraint) {\n    if (\n      validRange(constraint) &&\n      satisfies('14.100.0', constraint) &&\n      satisfies('15.100.0', constraint) &&\n      !isStable('16.100.0')\n    ) {\n      if (lockfileVersion === 2) {\n        logger.debug('Forcing node 15 to ensure lockfileVersion=2 is used');\n        constraint = '>=15';\n      } else if (validRange(`${constraint} <15`)) {\n        logger.debug('Augmenting constraint to avoid node 15');\n        constraint = `${constraint} <15`;\n      }\n    }\n  } else if (allowUnstable && lockfileVersion === 2) {\n    logger.debug('Using node >=15 for lockfileVersion=2');\n    constraint = '>=15';\n  } else {\n    logger.debug('No node constraint found - using latest');\n  }\n  return constraint;\n}\n"]}