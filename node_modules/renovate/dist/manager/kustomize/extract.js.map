{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../lib/manager/kustomize/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { load } from 'js-yaml';\nimport * as datasourceDocker from '../../datasource/docker';\nimport * as datasourceGitTags from '../../datasource/git-tags';\nimport * as datasourceGitHubTags from '../../datasource/github-tags';\nimport { logger } from '../../logger';\nimport { SkipReason } from '../../types';\nimport * as dockerVersioning from '../../versioning/docker';\nimport type { PackageDependency, PackageFile } from '../types';\nimport type { Image, Kustomize } from './types';\n\n// URL specifications should follow the hashicorp URL format\n// https://github.com/hashicorp/go-getter#url-format\nconst gitUrl =\n  /^(?:git::)?(?<url>(?:(?:(?:http|https|ssh):\\/\\/)?(?:.*@)?)?(?<path>(?:[^:/\\s]+(?::[0-9]+)?[:/])?(?<project>[^/\\s]+\\/[^/\\s]+)))(?<subdir>[^?\\s]*)\\?ref=(?<currentValue>.+)$/;\n\nexport function extractBase(base: string): PackageDependency | null {\n  const match = gitUrl.exec(base);\n\n  if (!match) {\n    return null;\n  }\n\n  if (match?.groups.path.startsWith('github.com')) {\n    return {\n      currentValue: match.groups.currentValue,\n      datasource: datasourceGitHubTags.id,\n      depName: match.groups.project.replace('.git', ''),\n    };\n  }\n\n  return {\n    datasource: datasourceGitTags.id,\n    depName: match.groups.path.replace('.git', ''),\n    lookupName: match.groups.url,\n    currentValue: match.groups.currentValue,\n  };\n}\n\nexport function extractImage(image: Image): PackageDependency | null {\n  if (image?.name && image.newTag) {\n    const replaceString = image.newTag;\n    let currentValue: string | undefined;\n    let currentDigest: string | undefined;\n    if (!is.string(replaceString)) {\n      return {\n        depName: image.newName ?? image.name,\n        currentValue: replaceString,\n        skipReason: SkipReason.InvalidValue,\n      };\n    }\n    if (replaceString.startsWith('sha256:')) {\n      currentDigest = replaceString;\n      currentValue = undefined;\n    } else {\n      currentValue = replaceString;\n    }\n    return {\n      datasource: datasourceDocker.id,\n      versioning: dockerVersioning.id,\n      depName: image.newName ?? image.name,\n      currentValue,\n      currentDigest,\n      replaceString,\n    };\n  }\n\n  return null;\n}\n\nexport function parseKustomize(content: string): Kustomize | null {\n  let pkg = null;\n  try {\n    pkg = load(content, { json: true });\n  } catch (e) /* istanbul ignore next */ {\n    return null;\n  }\n\n  if (!pkg) {\n    return null;\n  }\n\n  if (pkg.kind !== 'Kustomization') {\n    return null;\n  }\n\n  pkg.bases = (pkg.bases || []).concat(\n    pkg.resources || [],\n    pkg.components || []\n  );\n  pkg.images = pkg.images || [];\n\n  return pkg;\n}\n\nexport function extractPackageFile(content: string): PackageFile | null {\n  logger.trace('kustomize.extractPackageFile()');\n  const deps: PackageDependency[] = [];\n\n  const pkg = parseKustomize(content);\n  if (!pkg) {\n    return null;\n  }\n\n  // grab the remote bases\n  for (const base of pkg.bases) {\n    const dep = extractBase(base);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  // grab the image tags\n  for (const image of pkg.images) {\n    const dep = extractImage(image);\n    if (dep) {\n      deps.push(dep);\n    }\n  }\n\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}