"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.extractAllDependencies = void 0;
const is_1 = __importDefault(require("@sindresorhus/is"));
const config_1 = require("../../../config");
const logger_1 = require("../../../logger");
const manager_1 = require("../../../manager");
const git_1 = require("../../../util/git");
const file_match_1 = require("./file-match");
const manager_files_1 = require("./manager-files");
async function extractAllDependencies(config) {
    let managerList = (0, manager_1.getManagerList)();
    if (is_1.default.nonEmptyArray(config.enabledManagers)) {
        logger_1.logger.debug('Applying enabledManagers filtering');
        managerList = managerList.filter((manager) => config.enabledManagers.includes(manager));
    }
    const extractList = [];
    const fileList = await (0, git_1.getFileList)();
    const tryConfig = (extractConfig) => {
        const matchingFileList = (0, file_match_1.getMatchingFiles)(extractConfig, fileList);
        if (matchingFileList.length) {
            extractList.push({ ...extractConfig, fileList: matchingFileList });
        }
    };
    for (const manager of managerList) {
        const managerConfig = (0, config_1.getManagerConfig)(config, manager);
        managerConfig.manager = manager;
        if (manager === 'regex') {
            for (const regexManager of config.regexManagers) {
                tryConfig((0, config_1.mergeChildConfig)(managerConfig, regexManager));
            }
        }
        else {
            tryConfig(managerConfig);
        }
    }
    const extractResults = await Promise.all(extractList.map(async (managerConfig) => {
        const packageFiles = await (0, manager_files_1.getManagerPackageFiles)(managerConfig);
        return { manager: managerConfig.manager, packageFiles };
    }));
    const extractions = {};
    let fileCount = 0;
    for (const { manager, packageFiles } of extractResults) {
        if (packageFiles === null || packageFiles === void 0 ? void 0 : packageFiles.length) {
            fileCount += packageFiles.length;
            logger_1.logger.debug(`Found ${manager} package files`);
            extractions[manager] = (extractions[manager] || []).concat(packageFiles);
        }
    }
    logger_1.logger.debug(`Found ${fileCount} package file(s)`);
    return extractions;
}
exports.extractAllDependencies = extractAllDependencies;
//# sourceMappingURL=index.js.map